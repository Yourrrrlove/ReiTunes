{% extends "base.html" %}

{% block content %}
<div id="now-playing"><span id="current-song">No song selected</span></div>
<audio id="player" controls></audio>
<input type="text" id="search" name="query" placeholder="SEARCH..." hx-post="/ui/search"
    hx-trigger="input changed delay:50ms" hx-target="#library-table tbody" autocomplete="off">
<div class="htmx-indicator">Searching...</div>
<table id="library-table">
    <thead>
        <tr>
            <th>Name</th>
            <th>Artist</th>
            <th>Album</th>
            <th>Play Count</th>
            <th>Bookmarks</th>
        </tr>
    </thead>
    <tbody>
        {% for item in items %}
        <tr data-url="{{ item.url }}">
            <td>{{ item.name }}</td>
            <td>{{ item.artist }}</td>
            <td>{{ item.album }}</td>
            <td>{{ item.play_count }}</td>
            <td>
                {% for bookmark in item.bookmarks.values() %}
                <span class="bookmark-emoji" data-position="{{ bookmark.position.as_secs() }}">
                    {{ bookmark.emoji | default("ðŸ”–") }}
                </span>
                {% endfor %}
            </td>
        </tr>
        {% endfor %}
    </tbody>
</table>
<script>
    const player = document.getElementById('player');
    const table = document.getElementById('library-table');
    const searchInput = document.getElementById('search');
    const currentSong = document.getElementById('current-song');

    table.addEventListener('click', (e) => {
        const row = e.target.closest('tr');
        if (row && row.dataset.url) {
            if (e.target.classList.contains('bookmark-emoji')) {
                const position = parseFloat(e.target.dataset.position);
                if (player.src === row.dataset.url) {
                    // If the same song is already playing, just jump to the position
                    player.currentTime = position;
                    if (player.paused) {
                        player.play();
                    }
                } else {
                    // If it's a different song, load it and set the position
                    player.src = row.dataset.url;
                    player.addEventListener('loadedmetadata', () => {
                        player.currentTime = position;
                        player.play();
                    }, { once: true });
                }
            } else {
                // If clicking on the row (not a bookmark), play from the beginning
                if (player.src !== row.dataset.url) {
                    player.src = row.dataset.url;
                }
                player.currentTime = 0;
                player.play();
            }
            const name = row.cells[0].textContent;
            const artist = row.cells[1].textContent;
            currentSong.textContent = `${name} - ${artist}`;
        }
    });

    document.addEventListener('keydown', (e) => {
        if (e.ctrlKey && e.key === 'f') {
            e.preventDefault();
            searchInput.focus();
        }
    });
</script>
{% endblock %}
